<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Push Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
            background-color: #f0f2f5;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.1s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #log {
            margin-top: 20px;
            padding: 15px;
            background: #2d3436;
            color: #dfe6e9;
            border-radius: 8px;
            text-align: left;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #2d3436;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
        }

        .modal {
            background: rgba(255, 255, 255, 0.95);
            width: 320px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            transform: translateY(-30px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 10px;
        }

        .modal-body {
            font-size: 16px;
            color: #636e72;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .modal-btn {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .modal-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.5);
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>ğŸ”” Web Push ëª¨ë‹¬ í…ŒìŠ¤íŠ¸</h1>
        <p>ì•Œë¦¼ì„ êµ¬ë…í•˜ê³  í…ŒìŠ¤íŠ¸ í•´ë³´ì„¸ìš”.</p>

        <div>
            <label style="font-weight:bold; color:#555;">User ID (UUID):</label><br>
            <input type="text" id="userId" value="550e8400-e29b-41d4-a716-446655440000"
                style="padding: 10px; width: 300px; margin: 15px 0; border:1px solid #ddd; border-radius:6px; font-family:monospace;">
        </div>

        <button id="subscribeBtn">ì•Œë¦¼ êµ¬ë…í•˜ê¸°</button>
        <button id="createScheduleBtn" style="background-color: #00cec9; display:none;">1. í…ŒìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ ìƒì„±</button>
        <button id="testBtn" style="background-color: #00b894; display:none;">2. í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ìš”ì²­</button>

        <div id="log">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
    </div>

    <!-- Pretty Modal -->
    <div class="modal-overlay" id="pushModal">
        <div class="modal">
            <span class="modal-icon">ğŸ””</span>
            <div class="modal-title" id="modalTitle">ì•Œë¦¼ ë„ì°©</div>
            <div class="modal-body" id="modalBody">ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            <button class="modal-btn" onclick="closeModal()">í™•ì¸</button>
        </div>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        const subscribeBtn = document.getElementById('subscribeBtn');
        const createScheduleBtn = document.getElementById('createScheduleBtn');
        const testBtn = document.getElementById('testBtn');
        const modalOverlay = document.getElementById('pushModal');

        function log(msg) {
            logDiv.textContent += '\n' + msg;
            console.log(msg);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // --- Modal Logic ---
        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title || 'ì•Œë¦¼';
            document.getElementById('modalBody').textContent = body || '';
            modalOverlay.style.display = 'flex';
            // Trigger reflow for animation
            void modalOverlay.offsetWidth;
            modalOverlay.classList.add('show');
        }

        function closeModal() {
            modalOverlay.classList.remove('show');
            setTimeout(() => {
                modalOverlay.style.display = 'none';
            }, 300);
        }

        // Listen for messages from Service Worker
        navigator.serviceWorker.addEventListener('message', function (event) {
            console.log('Client Received Message:', event.data);
            if (event.data && event.data.type === 'PUSH_NOTIFICATION') {
                const payload = event.data.payload;
                showModal(payload.title, payload.body);
                log('âœ¨ ëª¨ë‹¬ ì•Œë¦¼ì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        });

        // Base64 URL to Uint8Array
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function subscribe() {
            try {
                if (!('serviceWorker' in navigator)) {
                    throw new Error('Service Workerë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                }

                // 1. Service Worker ë“±ë¡
                log('Registering Service Worker...');
                const registration = await navigator.serviceWorker.register('/sw.js');
                await registration.update(); // SW ê°±ì‹ 
                log('Service Worker Registered & Updated.');

                // 2. VAPID Key ê°€ì ¸ì˜¤ê¸°
                log('Fetching VAPID Public Key...');
                const keyRes = await fetch('/api/v1/analytics/push/vapid-key/');
                const keyData = await keyRes.json();
                if (!keyData.publicKey) throw new Error('VAPID Key ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');

                const convertedVapidKey = urlBase64ToUint8Array(keyData.publicKey);

                // 3. ë¸Œë¼ìš°ì € Push Manager êµ¬ë…
                log('Subscribing to Push Manager...');
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: convertedVapidKey
                });

                // 4. ì„œë²„ì— êµ¬ë… ì •ë³´ ì „ì†¡
                const userId = document.getElementById('userId').value;
                const subJson = subscription.toJSON();

                log('Sending subscription to server...');
                const res = await fetch('/api/v1/analytics/push/subscribe/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        endpoint: subJson.endpoint,
                        keys: subJson.keys
                    })
                });

                if (res.ok) {
                    log('âœ… êµ¬ë… ì„±ê³µ!');
                    subscribeBtn.disabled = true;
                    subscribeBtn.textContent = "êµ¬ë… ì™„ë£Œë¨";
                    createScheduleBtn.style.display = "inline-block";
                    testBtn.style.display = "inline-block";
                } else {
                    const err = await res.json();
                    throw new Error('ì„œë²„ ë“±ë¡ ì‹¤íŒ¨: ' + JSON.stringify(err));
                }

            } catch (e) {
                log('âŒ Error: ' + e.message);
            }
        }

        async function createTestSchedule() {
            try {
                const userId = document.getElementById('userId').value;
                // ë°”ë¡œ ì•Œë¦¼ì„ ë°›ê¸° ìœ„í•´ 10ë¶„ ì „ìœ¼ë¡œ ì„¤ì • (íƒ€ì„ì¡´ ì°¨ì´ ê³ ë ¤)
                const now = new Date();
                now.setMinutes(now.getMinutes() - 10);

                log('Creating test schedule for: ' + now.toLocaleString());

                const res = await fetch('/api/v1/analytics/schedules/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        scheduled_at: now.toISOString(),
                        domain: 'cs',
                        note: 'Web Push Test'
                    })
                });

                if (res.ok) {
                    log('âœ… í…ŒìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ ìƒì„± ì™„ë£Œ! (10ë¶„ ì „ ê¸°ì¤€)');
                } else {
                    const err = await res.json();
                    throw new Error(JSON.stringify(err));
                }
            } catch (e) {
                log('Error: ' + e.message);
            }
        }

        async function requestTestNotification() {
            try {
                log('Checking for due schedules...');
                const res = await fetch('/api/v1/analytics/schedules/check-notify/', {
                    method: 'POST'
                });
                const data = await res.json();
                console.log("Check Notify Response:", data);

                if (data.notified && data.notified.length > 0) {
                    log('ğŸ”” ì„œë²„ ì „ì†¡ ì„±ê³µ! (' + data.notified.length + 'ê±´)');
                    log('ìƒì„¸: ' + JSON.stringify(data.notified));
                } else if (data.due_count === 0) {
                    log('âš ï¸ ì•Œë¦¼ ë³´ë‚¼ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤. [í…ŒìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ ìƒì„±]ì„ ë¨¼ì € í•˜ì„¸ìš”.');
                } else {
                    log('âŒ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ' + JSON.stringify(data.failed));
                }
            } catch (e) {
                log('Error: ' + e.message);
            }
        }

        subscribeBtn.addEventListener('click', subscribe);
        createScheduleBtn.addEventListener('click', createTestSchedule);
        testBtn.addEventListener('click', requestTestNotification);
    </script>
</body>

</html>