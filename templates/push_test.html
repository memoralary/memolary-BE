<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Push Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }

        button:disabled {
            background-color: #ccc;
        }

        #log {
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            text-align: left;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>ğŸ”” Web Push í…ŒìŠ¤íŠ¸</h1>
        <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•˜ê³  êµ¬ë…í•˜ì„¸ìš”.</p>

        <div>
            <label>User ID (UUID):</label><br>
            <input type="text" id="userId" value="550e8400-e29b-41d4-a716-446655440000"
                style="padding: 5px; width: 300px; margin: 10px 0;">
        </div>

        <button id="subscribeBtn">ì•Œë¦¼ êµ¬ë…í•˜ê¸°</button>
        <button id="createScheduleBtn" style="background-color: #17a2b8; display:none;">1. í…ŒìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ ìƒì„±</button>
        <button id="testBtn" style="background-color: #28a745; display:none;">2. í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ìš”ì²­</button>

        <div id="log">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        const subscribeBtn = document.getElementById('subscribeBtn');
        const createScheduleBtn = document.getElementById('createScheduleBtn');
        const testBtn = document.getElementById('testBtn');

        function log(msg) {
            logDiv.textContent += '\n' + msg;
            console.log(msg);
        }

        // Base64 URL to Uint8Array
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function subscribe() {
            try {
                if (!('serviceWorker' in navigator)) {
                    throw new Error('Service Workerë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                }

                // 1. Service Worker ë“±ë¡
                log('Registering Service Worker...');
                const registration = await navigator.serviceWorker.register('/sw.js');
                await registration.update(); // SW ê°±ì‹ 
                log('Service Worker Registered & Updated.');

                // 2. VAPID Key ê°€ì ¸ì˜¤ê¸°
                log('Fetching VAPID Public Key...');
                const keyRes = await fetch('/api/v1/analytics/push/vapid-key/');
                const keyData = await keyRes.json();
                if (!keyData.publicKey) throw new Error('VAPID Key ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');

                const convertedVapidKey = urlBase64ToUint8Array(keyData.publicKey);

                // 3. ë¸Œë¼ìš°ì € Push Manager êµ¬ë…
                log('Subscribing to Push Manager...');
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: convertedVapidKey
                });

                // 4. ì„œë²„ì— êµ¬ë… ì •ë³´ ì „ì†¡
                const userId = document.getElementById('userId').value;
                const subJson = subscription.toJSON();

                log('Sending subscription to server...');
                const res = await fetch('/api/v1/analytics/push/subscribe/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        endpoint: subJson.endpoint,
                        keys: subJson.keys
                    })
                });

                if (res.ok) {
                    log('âœ… êµ¬ë… ì„±ê³µ!');
                    subscribeBtn.disabled = true;
                    subscribeBtn.textContent = "êµ¬ë… ì™„ë£Œë¨";
                    createScheduleBtn.style.display = "inline-block";
                    testBtn.style.display = "inline-block";
                } else {
                    const err = await res.json();
                    throw new Error('ì„œë²„ ë“±ë¡ ì‹¤íŒ¨: ' + JSON.stringify(err));
                }

            } catch (e) {
                log('âŒ Error: ' + e.message);
            }
        }

        async function createTestSchedule() {
            try {
                const userId = document.getElementById('userId').value;
                // ë°”ë¡œ ì•Œë¦¼ì„ ë°›ê¸° ìœ„í•´ 10ë¶„ ì „ìœ¼ë¡œ ì„¤ì • (íƒ€ì„ì¡´ ì°¨ì´ ê³ ë ¤)
                const now = new Date();
                now.setMinutes(now.getMinutes() - 10);

                log('Creating test schedule for: ' + now.toLocaleString());

                const res = await fetch('/api/v1/analytics/schedules/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        scheduled_at: now.toISOString(),
                        domain: 'cs',
                        note: 'Web Push Test'
                    })
                });

                if (res.ok) {
                    log('âœ… í…ŒìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ ìƒì„± ì™„ë£Œ! (10ë¶„ ì „ ê¸°ì¤€)');
                } else {
                    const err = await res.json();
                    throw new Error(JSON.stringify(err));
                }
            } catch (e) {
                log('Error: ' + e.message);
            }
        }

        async function requestTestNotification() {
            try {
                log('Checking for due schedules...');
                const res = await fetch('/api/v1/analytics/schedules/check-notify/', {
                    method: 'POST'
                });
                const data = await res.json();
                console.log("Check Notify Response:", data);

                if (data.notified && data.notified.length > 0) {
                    log('ğŸ”” ì„œë²„ ì „ì†¡ ì„±ê³µ! (' + data.notified.length + 'ê±´)');
                    log('ìƒì„¸: ' + JSON.stringify(data.notified));
                    log('Notice: ë¸Œë¼ìš°ì €ì— ì•Œë¦¼ì´ ì•ˆ ëœ¬ë‹¤ë©´ OS ì•Œë¦¼ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
                } else if (data.due_count === 0) {
                    log('âš ï¸ ì•Œë¦¼ ë³´ë‚¼ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤. [í…ŒìŠ¤íŠ¸ ìŠ¤ì¼€ì¤„ ìƒì„±]ì„ ë¨¼ì € í•˜ì„¸ìš”.');
                } else {
                    log('âŒ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ' + JSON.stringify(data.failed));
                }
            } catch (e) {
                log('Error: ' + e.message);
            }
        }

        subscribeBtn.addEventListener('click', subscribe);
        createScheduleBtn.addEventListener('click', createTestSchedule);
        testBtn.addEventListener('click', requestTestNotification);
    </script>
</body>

</html>