name: Deploy to EC2

on:
  push:
    branches:
      - back/build/16
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

env:
  PYTHON_VERSION: '3.12'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          python manage.py test --verbosity=2
        env:
          DJANGO_SETTINGS_MODULE: backend.settings
          SECRET_KEY: test-secret-key-for-ci

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test  # í…ŒìŠ¤íŠ¸ í†µê³¼ í›„ ë°°í¬
    if: github.ref == 'refs/heads/back/build/16'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 30m
          request_pty: false      # PTY ë¹„í™œì„±í™” â†’ SIGTERM ë°©ì§€
          script_stop: false      # ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬ ì‹œì—ë„ ê³„ì† ì§„í–‰
          script: |
            set -e
            
            PROJECT_DIR=~/memolary-backend
            
            # ============================================
            # ë””ìŠ¤í¬ ì •ë¦¬ (ì•ˆì „í•˜ê²Œ)
            # ============================================
            echo "ğŸ§¹ Cleaning up disk space..."
            sudo apt clean || true
            pip cache purge || true
            
            # ============================================
            # ì´ˆê¸° ì„¤ì • (í”„ë¡œì íŠ¸ê°€ ì—†ìœ¼ë©´ ì‹¤í–‰)
            # ============================================
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ”§ Initial setup - installing dependencies..."
              
              # Python 3.12 ì„¤ì¹˜
              sudo apt update
              sudo apt install -y software-properties-common
              sudo add-apt-repository -y ppa:deadsnakes/ppa
              sudo apt update
              sudo apt install -y python3.12 python3.12-venv python3.12-dev git redis-server
              
              # Redis ì‹œì‘
              sudo systemctl enable redis-server
              sudo systemctl start redis-server
              
              # í”„ë¡œì íŠ¸ í´ë¡ 
              cd ~
              git clone https://github.com/memoralary/memolary-BE.git memolary-backend
              cd $PROJECT_DIR
              
              # ê°€ìƒí™˜ê²½ ìƒì„±
              python3.12 -m venv venv
              source venv/bin/activate
              pip install --upgrade pip
              
              # âš ï¸ CPU PyTorch ë¨¼ì € ì„¤ì¹˜ (CUDA ë°©ì§€)
              echo "ğŸ“¦ Installing CPU-only PyTorch..."
              pip install torch==2.5.1+cpu --extra-index-url https://download.pytorch.org/whl/cpu
              
              # ë‚˜ë¨¸ì§€ ì˜ì¡´ì„± ì„¤ì¹˜
              pip install -r requirements.txt --no-deps || pip install -r requirements.txt
              
              echo "âœ… Initial setup completed!"
            fi
            
            # ============================================
            # ë°°í¬
            # ============================================
            cd $PROJECT_DIR
            
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch origin back/build/16
            git reset --hard origin/back/build/16
            
            # ê°€ìƒí™˜ê²½ í™œì„±í™”
            source venv/bin/activate
            
            # pip ìºì‹œ ì •ë¦¬ í›„ ì„¤ì¹˜
            pip cache purge || true
            
            # CPU PyTorch ë¨¼ì € í™•ì¸/ì„¤ì¹˜
            pip show torch | grep -q "cpu" || pip install torch==2.5.1+cpu --extra-index-url https://download.pytorch.org/whl/cpu
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            pip install -r requirements.txt
            
            # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
            python manage.py migrate --noinput
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            pkill -f "gunicorn" || true
            pkill -f "celery" || true
            sleep 2
            
            # ============================================
            # ë°±ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ (SSH ì„¸ì…˜ê³¼ ì™„ì „ ë¶„ë¦¬)
            # ============================================
            # í•µì‹¬: stdin ë‹«ê¸° (</dev/null) + stdout/stderr ë¦¬ë‹¤ì´ë ‰íŠ¸ + disown
            
            # Gunicorn ì‹¤í–‰
            nohup venv/bin/gunicorn backend.wsgi:application \
              --bind 0.0.0.0:8000 \
              --workers 3 \
              --timeout 120 \
              </dev/null >gunicorn.log 2>&1 &
            GUNICORN_PID=$!
            disown $GUNICORN_PID
            echo "Gunicorn started with PID: $GUNICORN_PID"
            
            # Celery ì›Œì»¤ ì‹¤í–‰
            nohup venv/bin/celery -A backend worker -l info --concurrency=2 \
              </dev/null >celery.log 2>&1 &
            CELERY_PID=$!
            disown $CELERY_PID
            echo "Celery started with PID: $CELERY_PID"
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            sleep 2
            ps aux | grep -E "(gunicorn|celery)" | grep -v grep || true
            
            echo "âœ… Deployment completed! Server running on port 8000"
            
            # ëª…ì‹œì  ì •ìƒ ì¢…ë£Œ
            exit 0
