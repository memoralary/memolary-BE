name: Deploy to EC2

on:
  push:
    branches:
      - back/build/16
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip --quiet
          pip install -r requirements.txt --quiet
      
      - name: Run tests
        run: |
          python manage.py test --verbosity=2
        env:
          DJANGO_SETTINGS_MODULE: backend.settings
          SECRET_KEY: test-secret-key-for-ci

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/back/build/16'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 30m
          request_pty: false
          script_stop: false
          script: |
            #!/bin/bash
            # ============================================
            # Memolary Backend ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
            # ============================================
            
            PROJECT_DIR=~/memolary-backend
            BRANCH="back/build/16"
            
            echo "ðŸš€ Starting deployment..."
            
            # ============================================
            # 1. ì´ˆê¸° ì„¤ì • (í”„ë¡œì íŠ¸ê°€ ì—†ì„ ë•Œë§Œ)
            # ============================================
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ðŸ“¦ First-time setup..."
              
              # ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ (ë¡œê·¸ ìµœì†Œí™”)
              sudo apt-get update -qq
              sudo apt-get install -y -qq software-properties-common
              sudo add-apt-repository -y ppa:deadsnakes/ppa
              sudo apt-get update -qq
              sudo apt-get install -y -qq python3.12 python3.12-venv python3.12-dev git redis-server curl
              
              # Redis ì‹œìž‘
              sudo systemctl enable redis-server --quiet
              sudo systemctl start redis-server
              
              # í”„ë¡œì íŠ¸ í´ë¡ 
              git clone --quiet https://github.com/memoralary/memolary-BE.git "$PROJECT_DIR"
              cd "$PROJECT_DIR"
              
              # ê°€ìƒí™˜ê²½ ìƒì„±
              python3.12 -m venv venv
              source venv/bin/activate
              
              # pip ì—…ê·¸ë ˆì´ë“œ + CPU PyTorch (ì¡°ìš©ížˆ)
              pip install --upgrade pip --quiet
              pip install torch==2.5.1+cpu --extra-index-url https://download.pytorch.org/whl/cpu --quiet --progress-bar off
              pip install -r requirements.txt --quiet --progress-bar off
              
              echo "âœ… Initial setup completed!"
            fi
            
            # ============================================
            # 2. ë°°í¬ (í•­ìƒ ì‹¤í–‰)
            # ============================================
            cd "$PROJECT_DIR"
            
            echo "ðŸ“¥ Fetching latest code..."
            git fetch origin "$BRANCH" --quiet
            git reset --hard "origin/$BRANCH" --quiet
            
            # ê°€ìƒí™˜ê²½ í™œì„±í™” (ì´í›„ ëª¨ë“  pip/python ëª…ë ¹ì— ì ìš©)
            source venv/bin/activate
            
            echo "ðŸ“¦ Installing dependencies..."
            # pip ìºì‹œ ì •ë¦¬ (venv í™œì„±í™” í›„ì—ë§Œ!)
            pip cache purge 2>/dev/null || true
            
            # ì˜ì¡´ì„± ì„¤ì¹˜ (ì¡°ìš©ížˆ + í”„ë¡œê·¸ë ˆìŠ¤ë°” ë”)
            pip install -r requirements.txt --quiet --progress-bar off 2>/dev/null
            
            echo "ðŸ—ƒï¸ Running migrations..."
            python manage.py migrate --noinput
            
            # ============================================
            # 3. ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
            # ============================================
            echo "ðŸ”„ Restarting services..."
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (ì—ëŸ¬ ë¬´ì‹œ)
            pkill -f "gunicorn.*backend.wsgi" 2>/dev/null || true
            pkill -f "celery.*backend" 2>/dev/null || true
            sleep 2
            
            # Gunicorn ì‹¤í–‰ (SSH ì„¸ì…˜ê³¼ ì™„ì „ ë¶„ë¦¬)
            nohup venv/bin/gunicorn backend.wsgi:application \
              --bind 0.0.0.0:8000 \
              --workers 3 \
              --timeout 120 \
              </dev/null >gunicorn.log 2>&1 &
            disown $!
            
            # Celery ì‹¤í–‰ (SSH ì„¸ì…˜ê³¼ ì™„ì „ ë¶„ë¦¬)
            nohup venv/bin/celery -A backend worker -l info --concurrency=2 \
              </dev/null >celery.log 2>&1 &
            disown $!
            
            sleep 3
            
            # ============================================
            # 4. í—¬ìŠ¤ì²´í¬
            # ============================================
            echo "ðŸ” Health check..."
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            GUNICORN_COUNT=$(pgrep -c -f "gunicorn.*backend.wsgi" || echo "0")
            CELERY_COUNT=$(pgrep -c -f "celery.*backend" || echo "0")
            
            if [ "$GUNICORN_COUNT" -gt 0 ] && [ "$CELERY_COUNT" -gt 0 ]; then
              echo "âœ… Services running: Gunicorn($GUNICORN_COUNT) Celery($CELERY_COUNT)"
            else
              echo "âš ï¸ Warning: Some services may not be running"
              echo "   Gunicorn: $GUNICORN_COUNT, Celery: $CELERY_COUNT"
            fi
            
            # API í—¬ìŠ¤ì²´í¬ (ì„ íƒì )
            sleep 2
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/ 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
              echo "âœ… API responding (HTTP $HTTP_CODE)"
            else
              echo "âš ï¸ API health check: HTTP $HTTP_CODE (may still be starting)"
            fi
            
            echo ""
            echo "ðŸŽ‰ Deployment completed successfully!"
            echo "   Server: http://$(curl -s ifconfig.me 2>/dev/null || echo 'YOUR_IP'):8000"
            
            exit 0

