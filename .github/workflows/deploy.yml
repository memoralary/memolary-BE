name: Deploy to EC2

on:
  push:
    branches:
      - back/feat/37
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip --quiet
          pip install -r requirements.txt --quiet
      
      - name: Run tests
        run: |
          python manage.py test --verbosity=2
        env:
          DJANGO_SETTINGS_MODULE: backend.settings
          SECRET_KEY: test-secret-key-for-ci

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/back/feat/37'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 30m
          request_pty: false
          script_stop: false
          script: |
            #!/bin/bash
            # ============================================
            # Memolary Backend ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
            # ============================================
            
            PROJECT_DIR=~/memolary-backend
            BRANCH="back/feat/37"
            
            echo "ğŸš€ Starting deployment..."
            
            # ============================================
            # 1. ì´ˆê¸° ì„¤ì • (í”„ë¡œì íŠ¸ê°€ ì—†ì„ ë•Œë§Œ)
            # ============================================
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ“¦ First-time setup..."
              
              # ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ (ë¡œê·¸ ìµœì†Œí™”)
              sudo apt-get update -qq
              sudo apt-get install -y -qq software-properties-common
              sudo add-apt-repository -y ppa:deadsnakes/ppa
              sudo apt-get update -qq
              sudo apt-get install -y -qq python3.12 python3.12-venv python3.12-dev git redis-server curl
              
              # Redis ì‹œì‘
              sudo systemctl enable redis-server --quiet
              sudo systemctl start redis-server
              
              # í”„ë¡œì íŠ¸ í´ë¡ 
              git clone --quiet https://github.com/memoralary/memolary-BE.git "$PROJECT_DIR"
              cd "$PROJECT_DIR"
              
              # ê°€ìƒí™˜ê²½ ìƒì„±
              python3.12 -m venv venv
              source venv/bin/activate
              
              # pip ì—…ê·¸ë ˆì´ë“œ + CPU PyTorch (ì¡°ìš©íˆ)
              pip install --upgrade pip --quiet
              pip install torch==2.5.1+cpu --extra-index-url https://download.pytorch.org/whl/cpu --quiet --progress-bar off
              pip install -r requirements.txt --quiet --progress-bar off
              
              echo "âœ… Initial setup completed!"
            fi
            
            # ============================================
            # 2. ë°°í¬ (í•­ìƒ ì‹¤í–‰)
            # ============================================
            cd "$PROJECT_DIR"
            
            echo "ğŸ“¥ Fetching latest code..."
            git fetch origin "$BRANCH" --quiet
            git reset --hard "origin/$BRANCH" --quiet
            
            # ê°€ìƒí™˜ê²½ í™œì„±í™” (ì´í›„ ëª¨ë“  pip/python ëª…ë ¹ì— ì ìš©)
            source venv/bin/activate
            
            echo "ğŸ“¦ Installing dependencies..."
            pip cache purge 2>/dev/null || true
            pip install -r requirements.txt --quiet --progress-bar off 2>/dev/null
            
            echo "ğŸ—ƒï¸ Running migrations..."
            python manage.py migrate --noinput
            
            # ============================================
            # 3. ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (systemd)
            # ============================================
            echo "ğŸ”„ Restarting services..."
            sudo systemctl restart gunicorn celery
            
            sleep 2
            
            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ” Health check..."
            sudo systemctl is-active --quiet gunicorn && echo "âœ… Gunicorn: active" || echo "âŒ Gunicorn: inactive"
            sudo systemctl is-active --quiet celery && echo "âœ… Celery: active" || echo "âŒ Celery: inactive"
            
            echo ""
            echo "ğŸ‰ Deployment completed!"
            exit 0
